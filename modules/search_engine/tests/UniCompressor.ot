group "search_engine.unicompressor";

require SEARCH_ENGINE;

include "modules/search_engine/UniCompressor.h";
include "modules/pi/system/OpLowLevelFile.h";
include "modules/pi/OpSystemInfo.h";

test("Uncompressible")
{
	UniCompressor uc;

	const uni_char *src = UNI_L("0123456789 \xFFFF \x7FFF e");
	unsigned char dst[54];  /* ARRAY OK 2010-09-24 roarl */
	uni_char chk[64];  /* ARRAY OK 2010-09-24 roarl */
	int size;

	verify_success(uc.InitCompDict());

	size = uc.Compress(dst, src);
	uc.Decompress(chk, dst, size);

	verify_string(chk, src);
}

test("Short input")
{
	UniCompressor uc;

	const uni_char *src = UNI_L("012012");
	unsigned char dst[54];  /* ARRAY OK 2010-09-24 roarl */
	uni_char chk[64];  /* ARRAY OK 2010-09-24 roarl */
	int size;

	verify_success(uc.InitCompDict());

	size = uc.Compress(dst, src);
	uc.Decompress(chk, dst, size);

	verify_string(chk, src);
}

test("Invalid input")
{
	UniCompressor uc;

	const uni_char *src = UNI_L("0123456789 \xFFFF \x7FFF e");
	uni_char chk[64];  /* ARRAY OK 2010-09-24 roarl */
	int size;

	size = uc.Decompress(chk, (unsigned char *)src, 16);

	verify(size == 0);
}

test("All compressed")
{
	UniCompressor uc;

	const uni_char *src = UNI_L("0101010101");
	unsigned char dst[54];  /* ARRAY OK 2010-09-24 roarl */
	uni_char chk[64];  /* ARRAY OK 2010-09-24 roarl */
	int size;

	verify_success(uc.InitCompDict());

	size = uc.Compress(dst, src);
	uc.Decompress(chk, dst, size);

	verify_string(chk, src);
	verify(size == 10);
}

test("Mixed data")
{
	UniCompressor uc;

	const uni_char *src = UNI_L("01A01B01C01D01");
	unsigned char dst[54];  /* ARRAY OK 2010-09-24 roarl */
	uni_char chk[64];  /* ARRAY OK 2010-09-24 roarl */
	int size;

	verify_success(uc.InitCompDict());

	size = uc.Compress(dst, src);
	uc.Decompress(chk, dst, size);

	verify_string(chk, src);
	verify(size == 20);
}

test("Random input to decompressor") // should not crash or trigger valgrind
{
	UniCompressor uc;

	unsigned char *src = OP_NEWA(unsigned char, 1024);
	uni_char *dst = OP_NEWA(uni_char, 2048+1); // null-terminated

	op_srand((unsigned int)op_time(0));
	src[0] = 2048 & 0xFF;
	src[1] = (2048 >> 8) & 0xFF;
	src[2] = (2048 >> 16) & 0xFF;
	src[3] = (2048 >> 24) & 0xFF;
	for (int i=0; i<10000; i++)
	{
		for (int j=4; j<1024; j++)
			src[j] = (unsigned char)(op_rand() & 0xff);
		uc.Decompress(dst, src, 1024);
	}
}
finally
{
	OP_DELETEA(src);
	OP_DELETEA(dst);
}

test("Random input to compressor")
{
	UniCompressor uc;
	uni_char letters[256]; /* ARRAY OK 2010-09-24 roarl */
	uni_char *src = OP_NEWA(uni_char, 0x20000);
	unsigned char *dst = OP_NEWA(unsigned char, 0x80000);
	uni_char *chk = OP_NEWA(uni_char, 0x40000);
	unsigned i, j, length, comp_length;
	double b, exp_b;

	verify_success(uc.InitCompDict());
	op_srand((unsigned int)op_time(0));

	for (i=0; i<100; i++)
	{
		// Create some random characters, distributed like e^(-x*b)
		b = 200;
		exp_b = op_exp(-b);
		for (j=0; j<256; j++) {
			double rnd = (op_rand()&0x7fffffff)/(double)0x7fffffff;
			letters[j] = (int)(-op_log(1-rnd+rnd*exp_b)/b * 65535)+1;
		}
		// Create a random block of compressible characters, distributed like e^(-x*b), 0 < x < 1
		length = 0x10000 + (op_rand()&0xffff);
		b = 200;
		exp_b = op_exp(-b);
		for (j=0; j<length; j++) {
			double rnd = (op_rand()&0x7fffffff)/(double)0x7fffffff;
			int val = (int)(-op_log(1-rnd+rnd*exp_b)/b * 255);
			src[j] = letters[val];
		}
		src[length] = 0;
	
		comp_length = uc.Compress(dst, src);
		verify(uc.Decompress(chk, dst, comp_length) == length);
		verify(op_memcmp(chk, src, (length+1)*sizeof(uni_char)) == 0);
		//printf("Compression ratio %f\n",(double)comp_length/length);
	}
}
finally
{
	OP_DELETEA(src);
	OP_DELETEA(dst);
	OP_DELETEA(chk);
}

test("long text")
{
	const char *utf8_text =
"English\n"
"The Free Encyclopedia\n"
"1 383 000+ articles\n"
"Deutsch\n"
"Die freie EnzyklopÃ¤die\n"
"465 000+ Artikel\n"
"FranÃ§ais\n"
"Lâ€™encyclopÃ©die libre\n"
"361 000+ articles\n"
"Polski\n"
"Wolna Encyklopedia\n"
"293 000+ haseÅ‚\n"
"æ—¥æœ¬èªž\n"
"ãƒ•ãƒªãƒ¼ç™¾ç§‘äº‹å…¸\n"
"258 000+ è¨˜äº‹\n"
"Nederlands\n"
"De vrije encyclopedie\n"
"226 000+ artikelen\n"
"Italiano\n"
"Lâ€™enciclopedia libera\n"
"195 000+ voci\n"
"Svenska\n"
"Den fria encyklopedin\n"
"182 000+ artiklar\n"
"PortuguÃªs\n"
"A enciclopÃ©dia livre\n"
"181 000+ artigos\n"
"EspaÃ±ol\n"
"La enciclopedia libre\n"
"152 000+ artÃ­culos\n"
"Search â€¢ Suche â€¢ Rechercher â€¢ Szukaj â€¢ æ¤œç´¢ â€¢ Zoeken â€¢ Ricerca â€¢ SÃ¶k â€¢ Busca â€¢ Buscar â€¢ ÐŸÐ¾Ð¸ÑÐº \n"
" 100 000+  \n"
"æ—¥æœ¬èªž â€¢ Ð ÑƒÑÑÐºÐ¸Ð¹ â€¢ Deutsch â€¢ English â€¢ EspaÃ±ol â€¢ FranÃ§ais â€¢ Italiano â€¢ Nederlands â€¢ Polski â€¢ PortuguÃªs â€¢ Svenska \n"
" 10 000+  \n"
"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© â€¢ ÙØ§Ø±Ø³ÛŒ â€¢ í•œêµ­ì–´ â€¢ ×¢×‘×¨×™×ª â€¢ à¹„à¸—à¸¢ â€¢ ä¸­æ–‡ â€¢ áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ â€¢ Î•Î»Î»Î·Î½Î¹ÎºÎ¬ â€¢ Ð‘ÑŠÐ»Ð³Ð°Ñ€ÑÐºÐ¸ â€¢ Ð¡Ñ€Ð¿ÑÐºÐ¸ â€¢ Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ° â€¢ Bosanski â€¢ CatalÃ  â€¢ ÄŒesky â€¢ Dansk â€¢ Eesti â€¢ Simple English â€¢ Esperanto â€¢ Euskara â€¢ Galego â€¢ Hrvatski â€¢ Ido â€¢ Bahasa Indonesia â€¢ Ãslenska â€¢ LÃ«tzebuergesch â€¢ LietuviÅ³ â€¢ Magyar â€¢ Bahasa Melayu â€¢ Norsk (bokmÃ¥l Â· nynorsk) â€¢ Nnapulitano â€¢ RomÃ¢nÄƒ â€¢ SlovenÄina â€¢ SlovenÅ¡Äina â€¢ Suomi â€¢ TÃ¼rkÃ§e â€¢ Tiáº¿ng Viá»‡t \n"
" 1000+  \n"
"Ø§Ø±Ø¯Ùˆ â€¢ Ø¦Û‡ÙŠØºÛ‡Ø±Ú†Ù‡ â€¢ à¦¬à¦¾à¦‚à¦²à¦¾ â€¢ à¤¹à¤¿à¤¨à¥à¤¦à¥€ â€¢ à²•à²¨à³à²¨à²¡ â€¢ à¤®à¤°à¤¾à¤ à¥€ â€¢ à®¤à®®à®¿à®´à¯ â€¢ à°¤à±†à°²à±à°—à± â€¢ ×™×™Ö´×“×™×© â€¢ ç²µèªž â€¢ Õ€Õ¡ÕµÕ¥Ö€Õ§Õ¶ â€¢ Ð‘ÐµÐ»Ð°Ñ€ÑƒÑÐºÐ°Ñ â€¢ Ð§ÄƒÐ²Ð°Ñˆ â€¢ Ð˜Ñ€Ð¾Ð½ Ã¦Ð²Ð·Ð°Ð³ â€¢ ÐœÐ°ÐºÐµÐ´Ð¾Ð½ÑÐºÐ¸ â€¢ Afrikaans â€¢ Alemannisch â€¢ AragonÃ©s â€¢ Arpitan â€¢ Asturianu â€¢ KreyÃ²l Ayisyen â€¢ AzÉ™rbaycan â€¢ BÃ¢n-lÃ¢m-gÃº â€¢ Basa Banyumasan â€¢ Brezhoneg â€¢ Corsu â€¢ Cymraeg â€¢ FÃ¸royskt â€¢ Frysk â€¢ Furlan â€¢ Gaeilge â€¢ GÃ idhlig â€¢ Ilokano â€¢ Interlingua â€¢ Basa Jawa â€¢ Kapampangan â€¢ Kernewek â€¢ KurdÃ® / ÙƒÙˆØ±Ø¯ÛŒ â€¢ Ladino / ×œ××“×™× ×• â€¢ Latina â€¢ LatvieÅ¡u â€¢ Limburgs â€¢ Lumbaart â€¢ Nedersaksisch â€¢ Nouormand â€¢ Occitan â€¢ Oâ€˜zbek â€¢ PiemontÃ¨is â€¢ PlattdÃ¼Ã¼tsch â€¢ Ripoarisch â€¢ SÃ¡megiella â€¢ Scots â€¢ Shqip â€¢ Sicilianu â€¢ Sinugboanon â€¢ Basa Sunda â€¢ Srpskohrvatski / Ð¡Ñ€Ð¿ÑÐºÐ¾Ñ…Ñ€Ð²Ð°Ñ‚ÑÐºÐ¸ â€¢ Kiswahili â€¢ Tagalog â€¢ TatarÃ§a â€¢ Walon â€¢ Winaray \n"
" 100+  \n"
"ÜÜªÜ¡ÜÜ â€¢ áŠ áˆ›áˆ­áŠ› â€¢ à½–à½¼à½‘à¼‹à½¡à½²à½‚ â€¢ à¤•à¤¶à¥à¤®à¥€à¤°à¥€ / ÙƒØ´Ù…ÙŠØ±ÙŠ â€¢ à¤¨à¥‡à¤ªà¤¾à¤²à¥€ â€¢ à¤¸à¤‚à¤¸à¥à¤•à¥ƒà¤¤à¤®à¥ â€¢ à·ƒà·’à¶‚à·„à¶½ â€¢ àª—à«àªœàª°àª¾àª¤à«€ â€¢ à´®à´²à´¯à´¾à´³à´‚ â€¢ Þ‹Þ¨ÞˆÞ¬Þ€Þ¨ â€¢ Ù¾ÚšØªÙˆ â€¢ á£áŽ³áŽ© â€¢ í €í¼²í €í¼¿í €í½„í €í¼¹í €í½ƒí €í¼º â€¢ ÐÐ²Ð°Ñ€ â€¢ Ð‘Ð°ÑˆÒ¡Ð¾Ñ€Ñ‚ â€¢ ÐšÑ‹Ñ€Ð³Ñ‹Ð·Ñ‡Ð° â€¢ ÐœÐ¾Ð»Ð´Ð¾Ð²ÐµÐ½ÑÑÐºÑ â€¢ ÐœÐ¾Ð½Ð³Ð¾Ð» â€¢ ÒšÐ°Ð·Ð°Ò›ÑˆÐ° â€¢ Ð¢Ð¾Ò·Ð¸ÐºÓ£ â€¢ Ð£Ð´Ð¼ÑƒÑ€Ñ‚ â€¢ ArmÃ¢neashti â€¢ Bamanankan â€¢ Deitsch â€¢ Eald Englisc â€¢ Gaelg â€¢ Interlingue â€¢ KaszÃ«bsczi â€¢ Kongo â€¢ Ligure â€¢ LingÃ¡la â€¢ lojban â€¢ Malagasy â€¢ Malti â€¢ MÄori â€¢ NÄhuatl â€¢ EkakairÅ© Naoero â€¢ Tok Pisin â€¢ Romani / à¤°à¥‹à¤®à¤¾à¤¨à¥€ â€¢ Rumantsch â€¢ Runa Simi â€¢ Sardu â€¢ Tetun â€¢ TÃ¼rkmen / ØªØ±ÙƒÙ…Ù† / Ð¢ÑƒÑ€ÐºÐ¼ÐµÐ½ â€¢ VÃ¨neto â€¢ VolapÃ¼k â€¢ VÃµro â€¢ West-Vlaoms â€¢ Wollof â€¢ Å½emaitÄ—Å¡ka \n"
"Other languages â€¢ Weitere Sprachen â€¢ ä»–ã®è¨€èªž â€¢ Kompletna lista jÄ™zykÃ³w â€¢ å…¶ä»–è¯­è¨€ â€¢ Aliaj lingvoj â€¢ ë‹¤ë¥¸ ì–¸ì–´ â€¢ NgÃ´n ngá»¯ khÃ¡c \n"
"   Wiktionary\n"
"   Wikibooks\n"
"   Wikiquote\n"
"   Wikisource\n"
"   Wikispecies\n"
"   Wikinews\n"
"   Commons\n"
"   Meta-Wiki\n";

	UniCompressor uc;
	OpString src;
	unsigned char dst[9600];  /* ARRAY OK 2010-09-24 roarl */
	uni_char chk[8000];  /* ARRAY OK 2010-09-24 roarl */
	int size, size_chk;

	verify_success(uc.InitCompDict());

	verify_success(src.SetFromUTF8(utf8_text));

	size = uc.Compress(dst, src.CStr());
	//output("\nInput size %u, compressed size=%u\n", (unsigned)((src.Length()+1)*2), size);
	size_chk = uc.Decompress(chk, dst, size);
	verify(size_chk == src.Length());

	verify_string(chk, src);
}

test("performance") disabled;
	file uni english_txt "data/english.txt";
{
	UniCompressor uc;
	OpString src;
	char *file_txt = NULL;
	unsigned char *dst = NULL;
	uni_char *chk = NULL;
	unsigned size, size_chk, i;
	OpLowLevelFile* f = NULL;
	BOOL exists;
	OpFileLength file_length;
	double time_1, time_2, time_3;

	verify_success(OpLowLevelFile::Create(&f, english_txt));
	verify_success(f->Exists(&exists));
	if (!exists)
	{
		output("\ndata/english.txt not found, aborting ...\n");
		verify(0);
	}

	verify_success(f->Open(OPFILE_READ));
	verify_success(f->GetFileLength(&file_length));
	verify((file_txt = OP_NEWA(char, file_length+1)) != NULL);
	verify_success(f->Read(file_txt, file_length));
	file_txt[file_length] = 0;
	verify_success(f->Close());
	verify((dst = OP_NEWA(unsigned char, 3 * (file_length+1)*2 / 2 + 6)) != NULL);
	verify((chk = OP_NEWA(uni_char, file_length+1)) != NULL);

	verify_success(uc.InitCompDict());
	verify_success(src.SetFromUTF8(file_txt));

	time_1 = g_op_system_info->GetWallClockMS();
	for (i=0; i<1000; i++)
		size = uc.Compress(dst, src);
	time_2 = g_op_system_info->GetWallClockMS();
	for (i=0; i<1000; i++)
		size_chk = uc.Decompress(chk, dst, size);
	time_3 = g_op_system_info->GetWallClockMS();

	verify(size_chk == (unsigned)src.Length());
	verify_string(chk, src);

	output("\nInput size %u, compressed size=%u\n", (unsigned)(src.Length()*2), size);
	output("Compression time %lg ms, decompression time %lg ms.\n",time_2-time_1, time_3-time_2);
}
finally
{
	OP_DELETE(f);
	OP_DELETEA(file_txt);
	OP_DELETEA(dst);
	OP_DELETEA(chk);
}

