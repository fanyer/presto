/* -*- Mode: c++; tab-width: 4; indent-tabs-mode: t; c-basic-offset: 4 -*- */
group "Forms.Submit";
require init;

language ecmascript;

include "modules/forms/form.h";
include "modules/forms/piforms.h";
include "modules/url/url_sn.h";
include "modules/url/url_pd.h";
include "modules/forms/formvalue.h";
include "modules/logdoc/htm_elm.h";
include "modules/logdoc/htm_ldoc.h";
include "modules/doc/frm_doc.h";
include "modules/url/url_rep.h";
include "modules/url/url_ds.h";
include "modules/upload/upload.h";

include "modules/forms/selftest/testhelpers.h";

subtest SetFileValue(HTML_Element* file_input, const OpString& file_name)
{
	FormValue* form_value = file_input->GetFormValue();
	verify(form_value);
	form_value->SetValueFromText(file_input, file_name.CStr());
}

subtest ComparePostSubmitData(Form& form_submitter, FramesDocument* frames_doc,
							  const char* expected, const char* expected_charset)
//	language C++;
{
	OP_STATUS status;
	URL submit_url = form_submitter.GetURL(frames_doc, status);
	verify_success(status);
	verify(!submit_url.IsEmpty());
	verify(submit_url.GetAttribute(URL::KHTTPIsFormsRequest));

	// This only works for Posted URL Encoded data
	URL_Rep* rep = submit_url.GetRep();
	verify(rep);
	URL_DataStorage* storage = rep->GetDataStorage();
	verify(storage);
	URL_HTTP_ProtocolData* http_protocol_data = storage->GetHTTPProtocolData();
	verify(http_protocol_data);

	OpStringC8 content_type = http_protocol_data->GetAttribute(URL::KHTTP_ContentType);
	verify(!content_type.IsEmpty());
	const char* charset = op_strstr(content_type.CStr(), "charset=");
	if (expected_charset)
	{
		if (!charset)
		{
			output("Missing charset in '%s'", content_type.CStr());
		}
		verify(charset);
		charset += sizeof("charset=")-1;
		verify_string(charset, expected_charset);
	}
	else
	{
		// didn't expect a charset
		if (charset)
		{
			output("Unwanted charset in '%s'", content_type.CStr());
		}
		verify(!charset);
	}

	const char* data = http_protocol_data->sendinfo.http_data.CStr();
	verify_string(data, expected);
}

subtest CompareGetSubmitData(Form& form_submitter, FramesDocument* frames_doc,
							 const char* expected)
//	language C++;
{
	OP_STATUS status;
	URL submit_url = form_submitter.GetURL(frames_doc, status);
	verify_success(status);
	verify(!submit_url.IsEmpty());
	verify(submit_url.GetAttribute(URL::KHTTPIsFormsRequest));
	const char* url_string = submit_url.GetAttribute(URL::KName_Escaped).CStr();
	verify(url_string);
	const char* query = op_strchr(url_string, '?');
	verify(query);
	verify_string(query+1, expected);
}

subtest CompareURLName(Form& form_submitter, FramesDocument* frames_doc,
					   const char* expected_url,
					   const char* expected_ref)
//	language C++;
{
	OP_STATUS status;
	URL submit_url = form_submitter.GetURL(frames_doc, status);
	verify_success(status);
	verify(!submit_url.IsEmpty());
	verify(submit_url.GetAttribute(URL::KHTTPIsFormsRequest));
	const char* url_string = submit_url.GetAttribute(URL::KName).CStr();
	verify(url_string);
	verify_string(url_string, expected_url);

	const char* ref_string = submit_url.RelName();
	if (ref_string)
		verify_string(ref_string, expected_ref);
	else
	{
		if (expected_ref && *expected_ref)
		{
			output("Expected RelName part '%s' missing", expected_ref);
		}
		verify(expected_ref == 0 || *expected_ref == 0);
	}
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="post">
	//! <input name="submit-name" type="text" value="thing">
	//! <input name="stamp" type="date" value="2001-04-05">
	//! <input name="dt" type="datetime">
	//! <input name="t" type="time">
	//! <input name="epost" type="email">
	//! <input name="web" type="uri">
	//! <input name="knapp" type="submit" value="Submit">
	//! </form></body></html>
}

test("SubmitFormatPostURLEncoded") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 7);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "submit-name=thing&stamp=2001-04-05&dt=&t=&epost=&web=&knapp=Submit";
	FramesDocument* frames_doc = state.doc;
	// NULL expected_charset since iso-8859-1 is default
	verify(ComparePostSubmitData(form_submitter, frames_doc, expected_data, NULL));
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="get">
	//! <input name="submit-name" type="text" value="thing">
	//! <input name="stamp" type="date" value="2001-04-05">
	//! <input name="dt" type="datetime">
	//! <input name="t" type="time">
	//! <input name="epost" type="email">
	//! <input name="web" type="uri">
	//! <input name="knapp" type="submit" value="Submit">
	//! </form></body></html>
}

test("SubmitFormatGetURLEncoded") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 7);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "submit-name=thing&stamp=2001-04-05&dt=&t=&epost=&web=&knapp=Submit";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html>
	//! <head><title>Test</title></head>
	//! <body>
	//! <form action='http://dummy.no/test.php' method='post'>
	//! <input type='radio' name='TEST[VALUE1]' value='1' CHECKED>Yes
	//! <input type='radio' name='TEST[VALUE1]' value='0'>No
	//! <input type='radio' name='TEST[VALUE1]' value=''>Reset
	//! <br>
	//! <input type='radio' name='TEST[VALUE2]' value='1'>Yes
	//! <input type='radio' name='TEST[VALUE2]' value='0' CHECKED>No
	//! <input type='radio' name='TEST[VALUE2]' value=''>Reset
	//! <br>
	//! <input type='radio' name='TEST[VALUE3]' value='1'>Yes
	//! <input type='radio' name='TEST[VALUE3]' value='0'>No
	//! <input type='radio' name='TEST[VALUE3]' value='' CHECKED>Reset
	//! <br><input type='submit' value='submit' name='SUBMIT'>
	//! </form></body></html>
}


test("Bug137923") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 10);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_data = "TEST%5BVALUE1%5D=1&TEST%5BVALUE2%5D=0&TEST%5BVALUE3%5D=&SUBMIT=submit";
	// NULL expected_charset since iso-8859-1 is default
	verify(ComparePostSubmitData(form_submitter, frames_doc, expected_data, NULL));
}

html
{
	//! <html>
	//! <head>
	//! <title>Test</title>
	//! </head>
	//! <body>
	//! <form action="http://dummy/test.htm" method="post">
	//! <div style="display:none">
	//! <input type="radio" name="test" value="0">
	//! <input type="radio" name="test" value="1" checked>
	//! <input type="radio" name="test" value="2">
	//! </div>
	//! <input type="submit" value="Submit">
	//! </form>
	//! </body>
	//! </html>
}

test("Bug139724") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 4);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_data = "test=1";
	// NULL expected_charset since iso-8859-1 is default
	verify(ComparePostSubmitData(form_submitter, frames_doc, expected_data, NULL));
}

/*
 * This doesn't test what it should. Must rephrase it somehow.
html
{
	//! <html>
	//! <head>
	//! <title>Test</title>
	//! </head>
	//! <body>
	//! <script>
	//!     document.submitCounter = 0;
	//! </script>
	//! <form action="http://dummy/test.htm" method="post">
	//! <input name="kalle" value="tut">
	//! <input name="btn" type="submit" value="Submit"
	//!    onclick="document.forms[0].submit();"
	//!    onsubmit="document.submitCounter++;return false;">
	//! </form>
	//! <script>
	//!     document.forms[0].btn.click();
	//! </script>
	//! </body>
	//! </html>
}

test("BugXXXX-onclickSubmit")
{
	verify(document.submitCounter == 1);
	// Should somehow check that the submit button
	// is included in the submit
}

*/

global
{
	#define WF2TESTFILE_ONE "wf2testfiletmp.txt"
}

subtest CompareMultiPartSubmitData(Form& form_submitter,
								   FramesDocument* frames_doc,
								   const char* expected)
{
	OP_STATUS status;
	URL submit_url = form_submitter.GetURL(frames_doc, status);
	verify_success(status);
	verify(!submit_url.IsEmpty());
	verify(submit_url.GetAttribute(URL::KHTTPIsFormsRequest));
	OpString8 data_obj;
	Upload_Base* upload = submit_url.GetRep()->GetDataStorage()->GetHTTPProtocolData()->sendinfo.upload_data;
	verify(upload);
	upload->ResetL();
	BOOL done = FALSE;
	while (!done)
	{
		unsigned char buf[4096]; // ARRAY OK bratell 2009-01-26
		uint32 written = upload->GetOutputData(buf, sizeof(buf), done);
		const char* buf_p = reinterpret_cast<char*>(buf);
		data_obj.AppendL(buf_p, written);
	}
	const char* data = data_obj.CStr();
	const char* data_p = data;
	const char* expected_p = expected;
	int state=0; // 0 = start of line, 1 = after 1 hyphen, 2 = in boundary line, 3 = in normal line
	const char* data_diff_p = NULL;
	const char* expected_diff_p = NULL;
	while (*data_p && *expected_p && !data_diff_p)
	{
		if (*data_p == *expected_p && *data_p == '\r' || *data_p == '\n')
		{
			state = 0;
		}
		else
		{
			switch (state)
			{
			case 0: // start of line
			case 1: // after one hyphen
				if (*data_p == *expected_p)
				{
					if (*data_p == '-')
					{
						state++; // 0->1, 1->2
					}
					else
					{
						state = 3;
					}
					break;
				}
				data_diff_p = data_p;
				expected_diff_p = expected_p;
				break;
			case 2: // Boundary line
				{
					// Remove boundary (could check these better)
					int expected_boundary_state = 0;
					while (*expected_p && *expected_p != '\r')
					{
						if (expected_boundary_state == 0 && *expected_p != '-')
							expected_boundary_state = 1;
						if (expected_boundary_state == 1 && *expected_p == '-')
							expected_boundary_state = 2;
						expected_p++;
					}
					int data_boundary_state = 0;
					while (*data_p && *data_p != '\r')
					{
						if (data_boundary_state == 0 && *data_p != '-')
							data_boundary_state = 1;
						if (data_boundary_state == 1 && *data_p == '-')
							data_boundary_state = 2;
						data_p++;
					}
					expected_p--; data_p--;
					if (expected_boundary_state != data_boundary_state)
					{
						data_diff_p = data_p;
						expected_diff_p = expected_p;
					}
					state = 3;
					break;
				}
			case 3: // Normal line
				if (*data_p != *expected_p)
				{
					data_diff_p = data_p;
					expected_diff_p = expected_p;
				}
				const char BOUNDARY_HEADER_PART[] =
					"boundary=---------";
				if (op_strncmp(data_p, BOUNDARY_HEADER_PART,
							sizeof(BOUNDARY_HEADER_PART)-1) == 0 &&
					op_strncmp(expected_p, BOUNDARY_HEADER_PART,
							sizeof(BOUNDARY_HEADER_PART)-1) == 0)
					{
						state = 2;
					}
			}
		}
		data_p++;
		expected_p++;
	}

	if (!data_diff_p && (*data_p || *expected_p))
	{
		data_diff_p = data_p;
		expected_diff_p = expected_p;
	}

	if (data_diff_p)
	{
		char data_char = *data_diff_p ? *data_diff_p : '.';
		char expected_char = *expected_diff_p ? *expected_diff_p : '.';

		OpString8 diff;
		diff.AppendFormat(
			"got (len = %d):\n"
			"----------------\n"
			"%s\n"
			"----------------\n"
			"expected (len = %d):\n"
			"----------------\n"
			"%s\n"
			"----------------\n"
			"The strings differ at pos %d in what we got where we "
			"got 0x%X ('%c') when we expected 0x%X ('%c')\n",
			(int)op_strlen(data), data,
			(int)op_strlen(expected), expected,
			int((data_diff_p-data)+1),
			(int)(unsigned char)*data_diff_p, data_char,
			(int)(unsigned char)*expected_diff_p, expected_char);
		output(diff.CStr());
	}
	verify(!data_diff_p);
}


html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="post"
	//!       enctype="multipart/form-data">
	//! <input name="submit-name" type="text" value="thing">
	//! <input name="filen" type="file" max="4">
	//! </form></body></html>
}

include "modules/forms/piforms.h";

test("Forms.SubmitFormatMultipartOneFile") language C++;
require _FILE_UPLOAD_SUPPORT_;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* file_input = find_element("input", 2);
	verify(file_input);
	verify(file_input->GetInputType() == INPUT_FILE);
	FormObject* file_input_obj = file_input->GetFormObject();
	verify(file_input_obj);
	const uni_char* testfilename_uni = UNI_L(WF2TESTFILE_ONE);

	OpString file_with_path;
	uni_char* file_with_path_p = file_with_path.ReserveL(1000);
	verify(file_with_path_p);
	verify(formtest_getcwd(file_with_path_p, 900));
	verify_success(file_with_path.Append(PATHSEP));
	verify_success(file_with_path.Append(testfilename_uni));
	OpString file_obj_value;
	verify_success(file_obj_value.Set("\""));
	verify_success(file_obj_value.Append(file_with_path));
	verify_success(file_obj_value.Append("\""));
	verify(SetFileValue(file_input, file_obj_value));
	OpFile test_file;
	const char file_data[] = "Test data that will be "
		"sent encoded\nWow!!!";
	verify_success(test_file.Construct(file_with_path.CStr()));
	verify_success(test_file.Open(OPFILE_WRITE));
	OP_STATUS write_ret = test_file.Write(file_data, sizeof(file_data)-1);
	verify_success(write_ret);
	test_file.Close();

	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_data =
		"Content-Type: multipart/form-data; boundary=----------NvhpDEAMnWcRi6tc8L7UFZ\r\n"
		"\r\n"
		"------------NvhpDEAMnWcRi6tc8L7UFZ\r\n"
		"Content-Disposition: form-data; name=\"submit-name\"\r\n"
		"\r\n"
		"thing\r\n"
		"------------NvhpDEAMnWcRi6tc8L7UFZ\r\n"
		"Content-Disposition: form-data; name=\"filen\"; filename=\"wf2testfiletmp.txt\"\r\n"
		"Content-Type: text/plain\r\n"
		"\r\n"
		"Test data that will be sent encoded\n"
		"Wow!!!\r\n"
		"------------NvhpDEAMnWcRi6tc8L7UFZ--\r\n";
	verify(CompareMultiPartSubmitData(form_submitter, frames_doc, expected_data));

	test_file.Delete();
}

test("Forms.SubmitFormatMultipartTwoFiles") language C++;
require _FILE_UPLOAD_SUPPORT_;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* file_input = find_element("input", 2);
	verify(file_input);
	verify(file_input->GetInputType() == INPUT_FILE);
	FormObject* file_input_obj = file_input->GetFormObject();
	verify(file_input_obj);
	const uni_char* testfilename_uni = UNI_L(WF2TESTFILE_ONE);

	OpString file_with_path;
	uni_char* file_with_path_p = file_with_path.ReserveL(1000);
	verify(file_with_path_p);
	verify(formtest_getcwd(file_with_path_p, 900));
	verify_success(file_with_path.Append(PATHSEP));
	verify_success(file_with_path.Append(testfilename_uni));
	OpString file_obj_value;
	// The same file name twice
	verify_success(file_obj_value.Set("\""));
	verify_success(file_obj_value.Append(file_with_path));
	verify_success(file_obj_value.Append("\";\""));
	verify_success(file_obj_value.Append(file_with_path));
	verify_success(file_obj_value.Append("\""));
	verify(SetFileValue(file_input, file_obj_value));
	OpFile test_file;
	const char file_data[] = "Test data that will be "
		"sent encoded\nWow!!!";
	verify_success(test_file.Construct(file_with_path.CStr()));
	verify_success(test_file.Open(OPFILE_WRITE));
	OP_STATUS write_ret = test_file.Write(file_data, sizeof(file_data)-1);
	verify_success(write_ret);
	test_file.Close();

	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;

	const char* expected_data =
		"Content-Type: multipart/form-data; boundary=----------FAFI5kHaxkbmXSn8pgJk5k\r\n"
		"\r\n"
		"------------FAFI5kHaxkbmXSn8pgJk5k\r\n"
		"Content-Disposition: form-data; name=\"submit-name\"\r\n"
		"\r\n"
		"thing\r\n"
		"------------FAFI5kHaxkbmXSn8pgJk5k\r\n"
		"Content-Disposition: form-data; name=\"filen\"; filename=\"wf2testfiletmp.txt\"\r\n"
		"Content-Type: text/plain\r\n"
		"\r\n"
		"Test data that will be sent encoded\n"
		"Wow!!!\r\n"
		"------------FAFI5kHaxkbmXSn8pgJk5k\r\n"
		"Content-Disposition: form-data; name=\"filen\"; filename=\"wf2testfiletmp.txt\"\r\n"
		"Content-Type: text/plain\r\n"
		"\r\n"
		"Test data that will be sent encoded\n"
		"Wow!!!\r\n"
		"------------FAFI5kHaxkbmXSn8pgJk5k--\r\n";

	verify(CompareMultiPartSubmitData(form_submitter, frames_doc, expected_data));

	test_file.Delete();
}

html
{
	//! <html><head>
	//! <form name=sf1 style="margin-bottom:0" action=r/zz><table cellpadding=0 cellspacing=0 border=0><tr><td nowrap><font face=arial size=-1>&nbsp; Search for:&nbsp;</font></td><td nowrap><font face=arial size=-1><input value=random type=text size=30 name=p>&nbsp;<select name=u><option value="http://search.yahoo.com/search?fr=fp-pull-web-t&p=">on the Web<option value="http://images.search.yahoo.com/search/images?fr=fp-pull-img-t&p=">in Images<option value="http://yp.search.yahoo.com/search/ypredirect?fr=fp-pull-yp-t&p=">in Yellow Pages&nbsp;<option value="http://news.search.yahoo.com/search/news?fr=fp-pull-news-t&p=">in News<option value="http://search.shopping.yahoo.com/search;_ylc=X3oDMTFncmo3bG5vBF9HA2dsb2JhbF9ncm91cARfUwMyNzE2MTQ5BHNlYwNzZWFyY2gEc2xrA2J1dHRvbg--?fr=fp-pull-prod-t&p=">in Products</select> <input name=sub type=submit value="Yahoo! Search">&nbsp;&nbsp;</font></td><td nowrap><font face=arial size=-2>&#149; <a href=r/so>Advanced</a><br>&#149; <a href=r/sy>Preferences</a> &nbsp;</font></td></tr></table></form>
	//! </body></html>
}

test("Yahoosubmit") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	// Expected URL:
	// http://www.yahoo.com/_ylh=X3oDMTB1c2ZmZzF2BF9TAzI3MTYxNDkEdGVzdAMwBHRtcGwDbnMtYmV0YQ--/r/zz?p=random&u=http%3A%2F%2Fsearch.yahoo.com%2Fsearch%3Ffr%3Dfp-pull-web-t%26p%3D&sub=Yahoo%21+Search
	const char* expected_data = "p=random&u=http%3A%2F%2Fsearch.yahoo.com%2Fsearch%3Ffr%3Dfp-pull-web-t%26p%3D&sub=Yahoo%21+Search";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}


html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="post"
	//!       accept-charset="utf-8,latin1" enctype="multipart/form-data">
	//! <input name="submit-name" type="text" value="räka">
	//! <input name="knapp" type="submit" value="Submit">
	//! </form></body></html>
}

test("Bug141575 (broken charset if utf-8 is first in multi-accept-charset)")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data =
		"Content-Type: multipart/form-data; charset=utf-8; boundary=----------JyoB7h1AgZq9KcET4WybnS\r\n"
		"\r\n"
		"------------JyoB7h1AgZq9KcET4WybnS\r\n"
		"Content-Disposition: form-data; name=\"submit-name\"\r\n"
		"\r\n"
		"r\303\244ka\r\n" // "\303\244" means "Ã¤" which is UTF-8 for "ä"
		"------------JyoB7h1AgZq9KcET4WybnS\r\n"
		"Content-Disposition: form-data; name=\"knapp\"\r\n"
		"\r\n"
		"Submit\r\n"
		"------------JyoB7h1AgZq9KcET4WybnS--\r\n";
	FramesDocument* frames_doc = state.doc;
	verify(CompareMultiPartSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><head>
	//! <form action=r/zz>Search for:
	//! <select name=u>
	//! <option value="A">A
	//! <option value="B">B
	//! <option value="C">C
	//! </select>
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit SELECT (GET) #1") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	// Expected URL:
	// http://.../r/zz?u=A
	const char* expected_data = "u=A";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><head>
	//! <form action=r/zz>Search for:
	//! <select name=u>
	//! <option value="A" selected>A
	//! <option value="B">B
	//! <option value="C">C
	//! </select>
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit SELECT (GET) #2") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	// Expected URL:
	// http://.../r/zz?u=A
	const char* expected_data = "u=A";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}


html
{
	//! <html><head>
	//! <form action=r/zz>Search for:
	//! <select name=u>
	//! <option value="A">A
	//! <option value="B">B
	//! <option value="C" selected>C
	//! </select>
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit SELECT (GET) #3") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	// Expected URL:
	// http://.../r/zz?u=A
	const char* expected_data = "u=C";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><head>
	//! <form action="dummy">
	//! <input name="pwd" type="password" value="secret">
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit PASSWORD (GET)") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "pwd=secret";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><head>
	//! <form action="dummy">
	//! <input name="c" type="radio" value="A">
	//! <input name="c" type="radio" value="B" checked>
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit RADIO (GET) #1") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 3);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "c=B";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><head>
	//! <form action="dummy">
	//! <input name="c" type="radio" value="A">
	//! <input name="c" type="radio" value="B">
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit RADIO (GET) #2") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 3);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><head>
	//! <form action="dummy">
	//! <input name="c" type="radio" value="A" checked>
	//! <input name="c" type="radio" value="B" checked>
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit RADIO (GET) #3") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 3);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "c=B";
	FramesDocument* frames_doc = state.doc;
	CompareGetSubmitData(form_submitter, frames_doc, expected_data);
}


html
{
	//! <html><head>
	//! <form action=r/zz>Search for:
	//! <input type="text" name="i" dirname="i.dir" value="AB">
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit TEXT with DIRNAME (GET) #1") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* input_elm = find_element("input", 1);
	HTML_Element* submit_elm = find_element("input", 2);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	verify(input_elm);
	verify(!input_elm->GetFormValue()->IsUserInputRTL(input_elm));
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	// Expected URL:
	const char* expected_data = "i=AB&i.dir=ltr";
	FramesDocument* frames_doc = state.doc;
	CompareGetSubmitData(form_submitter, frames_doc, expected_data);
}

html
{
	//! <html><head>
	//! <form action=r/zz>Search for:
	//! <input type="text" name="i" dirname="i.dir" value="AB">
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit TEXT with DIRNAME (GET) #2") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* input_elm = find_element("input", 1);
	HTML_Element* submit_elm = find_element("input", 2);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	verify(input_elm);
	verify(!input_elm->GetFormValue()->IsUserInputRTL(input_elm));
	FormObject* form_object = input_elm->GetFormObject();
	verify(form_object);
	form_object->SetInRTLMode(TRUE);
	verify(input_elm->GetFormValue()->IsUserInputRTL(input_elm));
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	// Expected URL:
	const char* expected_data = "i=AB&i.dir=rtl";
	FramesDocument* frames_doc = state.doc;
	CompareGetSubmitData(form_submitter, frames_doc, expected_data);
}

html
{
	//! <html><head>
	//! <form action=r/zz>Search for:
	//! <textarea name="i" dirname="i.dir">AB</textarea>
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit TEXTAREA with DIRNAME (GET) #1") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* textarea_elm = find_element("textarea");
	HTML_Element* submit_elm = find_element("input");
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	verify(textarea_elm);
	verify(!textarea_elm->GetFormValue()->IsUserInputRTL(textarea_elm));
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	// Expected URL:
	const char* expected_data = "i=AB&i.dir=ltr";
	FramesDocument* frames_doc = state.doc;
	CompareGetSubmitData(form_submitter, frames_doc, expected_data);
}

html
{
	//! <html><head>
	//! <form action=r/zz>Search for:
	//! <textarea name="i" dirname="i.dir">AB</textarea>
	//! <input type=submit>
	//! </form>
	//! </body></html>
}

test("Submit TEXTAREA with DIRNAME (GET) #2") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* textarea_elm = find_element("textarea");
	HTML_Element* submit_elm = find_element("input");
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	verify(textarea_elm);
	verify(!textarea_elm->GetFormValue()->IsUserInputRTL(textarea_elm));
	FormObject* form_object = textarea_elm->GetFormObject();
	verify(form_object);
	form_object->SetInRTLMode(TRUE);
	verify(textarea_elm->GetFormValue()->IsUserInputRTL(textarea_elm));
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	// Expected URL:
	const char* expected_data = "i=AB&i.dir=rtl";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       action="http://dummy.dummy/dummy/"
	//!       method="POST" accept-charset="ascii,latin1">
	//!       <input name="str" type="hidden" value="räksmörgås">
	//! </form>
	//! </body></html>
}

test("accept-charset#1")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_data = "str=r%E4ksm%F6rg%E5s";
	// No explicit charset since doc_charset == "iso-8859-1" and
	// submit charset == "iso-8859-1"
	verify(ComparePostSubmitData(form_submitter, frames_doc, expected_data, NULL));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       action="http://dummy.dummy/dummy/"
	//!       method="POST" accept-charset="ascii,latin1">
	//!       <input name="str" type="hidden" value="shrimp sandwich">
	//! </form>
	//! </body></html>
}

test("accept-charset#2")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_data = "str=shrimp+sandwich";
	verify(ComparePostSubmitData(form_submitter, frames_doc, expected_data, "us-ascii"));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       action="http://dummy.dummy/dummy/"
	//!       method="POST" accept-charset=", , , ,   ,">
	//!       <input name="str" type="hidden" value="shrimp sandwich">
	//! </form>
	//! </body></html>
}

test("accept-charset#3")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_data = "str=shrimp+sandwich";
	// No explicit charset since doc_charset == "iso-8859-1" and
	// submit charset == "iso-8859-1"
	verify(ComparePostSubmitData(form_submitter, frames_doc, expected_data, NULL));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       action="http://dummy.dummy/dummy/"
	//!       method="POST" accept-charset="ascii,us-ascii">
	//!       <input name="str" type="hidden" value="räksmörgås">
	//! </form>
	//! </body></html>
}

test("accept-charset#4")
	language C++;
{
	// This test might in the future require manual intervention
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	// Without entity coding
	// const char* expected_data = "str=r?ksm?rg?s";
	// With entity coding
#ifdef ENCODINGS_HAVE_ENTITY_ENCODING
	const char* expected_data =
		"str=r%26%23228%3Bksm%26%23246%3Brg%26%23229%3Bs";
#else
	const char* expected_data =
		"str=r%3Fksm%3Frg%3Fs"; // Unknowns become question marks
#endif // ENCODINGS_HAVE_ENTITY_ENCODING
	verify(ComparePostSubmitData(form_submitter, frames_doc,
                                 expected_data, "us-ascii"));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       action="http://dummy.dummy/dummy/#ref"
	//!       method="GET">
	//!       <input name="str" value="val">
	//! </form>
	//! </body></html>
}

test("Get with ref in action")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_url =
		"http://dummy.dummy/dummy/?str=val";
	const char* expected_ref = "ref";
	verify(CompareURLName(form_submitter, frames_doc, expected_url, expected_ref));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       action="http://dummy.dummy/dummy?jo=wow"
	//!       method="GET">
	//!       <input name="str" value="val">
	//! </form>
	//! </body></html>
}

test("Get with existing query in action")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_url =
		"http://dummy.dummy/dummy?str=val";
	const char* expected_ref = "";
	verify(CompareURLName(form_submitter, frames_doc, expected_url, expected_ref));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       action="http://dummy.dummy/dummy?jo=wow#ref"
	//!       method="GET">
	//!       <input name="str" value="val">
	//! </form>
	//! </body></html>
}

test("Get with existing query and ref in action")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_url =
		"http://dummy.dummy/dummy?str=val";
	const char* expected_ref = "ref";
	verify(CompareURLName(form_submitter, frames_doc, expected_url, expected_ref));
}

// Need a base url since otherwise the url will be destroyed while
// parsing (opera:blanker#kalle is no longer accepted by the url
// module)
html
{
	//! <html><body>
	//! <base href="http://dummy.parent/dummy.cgi?str=val">
	//! <form name="intro"
	//!       action="#kalle"
	//!       method="GET">
	//!       <input name="str" value="val">
	//! </form>
	//! </body></html>
}

test("Get with nothing in action but the ref")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "http://dummy.parent/dummy.cgi");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_url =
		"http://dummy.parent/dummy.cgi?str=val";
	const char* expected_ref = "kalle";
	verify(CompareURLName(form_submitter, frames_doc, expected_url, expected_ref));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       method="GET">
	//!       <input name="str" value="val">
	//! </form>
	//! </body></html>
}

test("Get with no specified action")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "http://dummy.parent/dummy.cgi");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_url =
		"http://dummy.parent/dummy.cgi?str=val";
	const char* expected_ref = "";
	verify(CompareURLName(form_submitter, frames_doc, expected_url, expected_ref));
}

html
{
	//! <html><body>
	//! <isindex prompt="en liten question">
	//! </body></html>
}

test("IsIndex - empty")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "http://dummy.parent/dummy.cgi");

	HTML_Element* form_elm = find_element("form");
	verify(form_elm);
	
	// We put a magic <input> inside the isindex
	HTML_Element* input_elm = find_element("input");
	verify(input_elm);
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_url = "http://dummy.parent/dummy.cgi?isindex=";
	
	const char* expected_ref = "";
	verify(CompareURLName(form_submitter, frames_doc, expected_url, expected_ref));
}

test("IsIndex - string")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "http://dummy.parent/dummy.cgi");

	HTML_Element* form_elm = find_element("form");
	verify(form_elm);
	
	// We put a magic <input> inside the isindex
	HTML_Element* input_elm = find_element("input");
	verify(input_elm);
	FormValue* form_value = input_elm->GetFormValue();
	form_value->SetValueFromText(input_elm, UNI_L("kalle olle"));
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_url = "http://dummy.parent/dummy.cgi?isindex=kalle+olle";
	const char* expected_ref = "";
	verify(CompareURLName(form_submitter, frames_doc, expected_url, expected_ref));
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="post"
	//!       enctype="multipart/form-data">
	//! <input name="knapp" type="submit" value="Submit">
	//! <input name="filen" type="text">
	//! </form></body></html>
}

test("FileValueSecurity resetting type setup")
	language C++;
	require _FILE_UPLOAD_SUPPORT_;
{
	// Create file to send
	OpString file_with_path;
	const uni_char* testfilename_uni = UNI_L(WF2TESTFILE_ONE);
	uni_char* file_with_path_p = file_with_path.ReserveL(1000);
	verify(file_with_path_p);
	verify(formtest_getcwd(file_with_path_p, 900));
	verify_success(file_with_path.Append(PATHSEP));
	verify_success(file_with_path.Append(testfilename_uni));
	OpFile test_file;
	const char file_data[] = "Test data that must not be sent!!!";
	verify_success(test_file.Construct(file_with_path.CStr()));
	verify_success(test_file.Open(OPFILE_WRITE));
	OP_STATUS write_ret = test_file.Write(file_data, sizeof(file_data)-1);
	verify_success(write_ret);
	test_file.Close();
	HTML_Element* input = find_element("input", 2);
	verify(input);
	verify(SetFileValue(input, file_with_path));
}

test("FileValueSecurity resetting type test part 1")
	require success "FileValueSecurity resetting type setup";
{
	verify(document);
	verify(document.forms);
	verify(document.forms[0]);
	var f = document.forms[0];
	verify(f["filen"]);
	var i = f["filen"];
	verify(i);
	verify(i.value);
	verify(i.value != "");

	verify(f.removeChild);
	f.removeChild(i);
	verify("type" in i);
	verify(i.type == "text");
	i.type = "file";
	f.style.display = "none";
	f.appendChild(i);
}

test("FileValueSecurity resetting type test part 2")
	language C++;
	require _FILE_UPLOAD_SUPPORT_; // We don't take the file value security so hard when we can't upload files anyway
	require success "FileValueSecurity resetting type test part 1";
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data =
		"Content-Type: multipart/form-data; boundary=----------uIIXGby3jr9GDc3Ji9dRON\r\n"
		"\r\n"
		"------------uIIXGby3jr9GDc3Ji9dRON\r\n"
		"Content-Disposition: form-data; name=\"knapp\"\r\n"
		"\r\n"
		"Submit\r\n"
		"------------uIIXGby3jr9GDc3Ji9dRON\r\n"
		"Content-Disposition: form-data; name=\"filen\"; filename=\"\"\r\n"
		"\r\n"
		"\r\n"
		"------------uIIXGby3jr9GDc3Ji9dRON--\r\n";
	// The other browsers (Firefox 0.8, MSIE 6.0.xxxx) has a
	// Content-Type: application/octet-stream header for the empty
	// block as well. Also see bug 130681.
	FramesDocument* frames_doc = state.doc;
	verify(CompareMultiPartSubmitData(form_submitter, frames_doc, expected_data));
}

test("FileValueSecurity resetting type cleanup")
	require success "FileValueSecurity resetting type setup";
	require _FILE_UPLOAD_SUPPORT_;
language C++;
{
	const uni_char* testfilename_uni = UNI_L(WF2TESTFILE_ONE);
	OpString file_with_path;
	uni_char* file_with_path_p = file_with_path.ReserveL(1000);
	verify(file_with_path_p);
	verify(formtest_getcwd(file_with_path_p, 900));
	verify_success(file_with_path.Append(PATHSEP));
	verify_success(file_with_path.Append(testfilename_uni));
	OpFile test_file;
	verify_success(test_file.Construct(file_with_path.CStr()));
	test_file.Delete();
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       method="GET">
	//!       <input name="pic" type="image">
	//!       <input name="knapp" type="submit" value="Submit">
	//! </form>
	//! </body></html>
}

test("Image submit")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "http://dummy.parent/dummy.cgi");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	int x = 18;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "pic.x=18&pic.y=23";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

test("Submit by button but with with image in form")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "http://dummy.parent/dummy.cgi");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	int x = 18;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "knapp=Submit";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><body>
	//! <form name="intro"
	//!       method="GET">
	//!       <input name="" type="image">
	//!       <input name="knapp" type="submit" value="Submit">
	//! </form>
	//! </body></html>
}

test("Image submit, empty name - bug 205755")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "http://dummy.parent/dummy.cgi");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	int x = 18;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "x=18&y=23";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}


html
{
	//! <html><head>
	//! <form action="http://localhost:8080/lek.jsp" method="POST">
	//! <keygen name="nyckel">
	//! </form>
	//! </body></html>
}

test("Keygen submit") language C++;
disabled; // Requires manual intervention
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "...";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

// Totally broken enctype -> skip enctype
html
{
	//! <html><body>
	//! <form name="intro"
	//!       action="http://dummy.dummy/dummy/"
	//!       method="POST" enctype="multipart/form-data: charset=utf-8">
	//!       <input type="hidden" value="räksmörgås">
	//! </form>
	//! </body></html>
}

html
{
	//! <html><head>
	//! <form action="http://localhost:8080/lek.jsp" method="POST">
	//! </form>
	//! </body></html>
}

test("Submit empty form - POST")
	language C++;
{
	// This test might in the future require manual intervention
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_data =	"";
	verify(ComparePostSubmitData(form_submitter, frames_doc,
                                 expected_data, NULL));
}

html
{
	//! <html><head>
	//! <form action="http://localhost:8080/lek.jsp" method="GET">
	//! </form>
	//! </body></html>
}

test("Submit empty form - GET")
	language C++;
{
	// This test might in the future require manual intervention
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	const char* expected_data =	"";
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="get">
    //! <button name="fail-1" value="reset type" type="reset"></button>
    //! <button name="fail-2" value="submit type" type="submit"></button>
    //! <button name="fail-3" value="button type" type="button"></button>
    //! <button name="fail-4" value="dummy type" type="dummy"></button>
    //! <button name="fail-5" value="default type"></button>
    //! <input type="button" name="fail-6" value="input button">
    //! <input type="reset" name="fail-7" value="input reset">
    //! <input type="submit" name="fail-8" value="input submit">
    //! <button name="test-1" value="pass"></button>
    //! <input type="submit" name="test-2" value="pass">
	//! </form></body></html>
}

test("Submit buttons submitted with button") language C++;
{
	// This was bug 146019
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("button", 6);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "test-1=pass";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

test("Submit buttons submitted with input button") language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 4);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "test-2=pass";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="get">
    //! <input name="field" value="123456">
    //! <input type="submit">
	//! </form></body></html>
}

test("GetQueryString.GET")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "https://telebank1.ubs.com/classic/e/?login&initiate");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	int x = 18;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	OP_STATUS status;
	URL submit_url = form_submitter.GetURL(frames_doc, status);
	verify_success(status);
	verify(!submit_url.IsEmpty());
	OpString8 query_string;
	verify_success(form_submitter.GetQueryString(query_string));
	verify_string(query_string, "field=123456");
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="post">
    //! <input name="field" value="123456">
    //! <input type="submit">
	//! </form></body></html>
}

test("GetQueryString.POST")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "https://telebank1.ubs.com/classic/e/?login&initiate");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	int x = 18;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	FramesDocument* frames_doc = state.doc;
	OP_STATUS status;
	URL submit_url = form_submitter.GetURL(frames_doc, status);
	verify_success(status);
	verify(!submit_url.IsEmpty());
	OpString8 query_string;
	verify_success(form_submitter.GetQueryString(query_string));
	verify_string(query_string, "field=123456");
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="post">
    //! <input name="field" value="123456">
    //! <input type="submit">
	//! </form></body></html>
}


test("Bug 144590 - don't include charset if not necessary (doc-charset=latin1)")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "https://telebank1.ubs.com/classic/e/?login&initiate");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	int x = 18;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "field=123456";
	FramesDocument* frames_doc = state.doc;
	verify(ComparePostSubmitData(form_submitter, frames_doc,
                                 expected_data, NULL)); // No charset
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="post" accept-charset="iso-8859-1">
    //! <input name="field" value="123456">
    //! <input type="submit">
	//! </form></body></html>
}

test("Bug 144590 - don't include charset if not necessary (doc-charset=ascii)")
	language C++;
{
	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "https://telebank1.ubs.com/classic/e/?login&initiate");
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	int x = 18;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "field=123456";
	FramesDocument* frames_doc = state.doc;
	verify_success(frames_doc->GetHLDocProfile()->SetCharacterSet("us-ascii"));
	verify(ComparePostSubmitData(form_submitter, frames_doc,
                                 expected_data, "windows-1252"));
}


html
{
	//! <!DOCTYPE html PUBLIC "-//WHATWG//NONSGML HTML5//EN">
	//! <html><head>
	//! <script type="text/javascript">
	//! function test()
	//! {
	//! var newelem = document.createElement("input");
	//! newelem.setAttribute("type", "text");
	//! newelem.setAttribute("value", "Filler text");
	//! document.getElementById("blockchild1").appendChild(newelem);
	//! }
	//! </script>
	//! </head>
	//! <body>
	//! <form>
	//! <p id="blockchild1"></p>
	//! </form>
    //! <script>test()</script>
    //! </body></html>
}

test("Bug 152041 - setting the value attribute before inserting into document")
	language C++;
{
	HTML_Element* input = find_element("input");
	verify(input);
	FormValue* form_value = input->GetFormValue();
	verify(form_value);
	OpString curr_val;
	verify_success(form_value->GetValueAsText(input, curr_val));
	verify(!curr_val.IsEmpty());
	verify_string(curr_val, "Filler text");
}

html
{
	//! <form>
    //! <input name="field" maxlength="12">
    //! <input name="field2" type="password" maxlength="12">
    //! <input type="submit">
}

test("Bug 151944 - the maxlength attribute shouldn't affect widget size")
	language C++;
{
	HTML_Element* input = find_element("input", 1);
	verify(input);
	int size = input->GetSize();
	verify (size != 12);
	verify (size == 20); // This might change

	// password element
	input = find_element("input", 2);
	verify(input);
	size = input->GetSize();
	verify (size != 12);
	verify (size == 20); // This might change
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="get"
	//!       accept-charset="UNKNWON">
	//! <input name="knapp" type="submit" value="Submit">
	//! </form></body></html>
}

test("Bug 159547 - invalid accept-charset")
	language C++;
{
	// Don't know if this will be ascii or iso-8859-1 but it should work
	// nevertheless

	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "https://telebank1.ubs.com/classic/e/?login&initiate");

	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "knapp=Submit";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="get"
	//!       accept-charset="UNKNOWN">
	//! <input name="knapp" type="submit" value="Submit">
	//! </form></body></html>
}


//  The default value for this attribute is the reserved string
//  "UNKNOWN". User agents may interpret this value as the
//  character encoding that was used to transmit the document
//  containing this FORM element.

test("Bug 159547 - \"UNKNOWN\" accept-charset")
	language C++;
{
	// Don't know if this will be ascii or iso-8859-1 but it should work
	// nevertheless

	URL parent_url;
	parent_url = g_url_api->GetURL(parent_url, "https://telebank1.ubs.com/classic/e/?login&initiate");

	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 1);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "knapp=Submit";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><body>
	//! <form name="intro" method="POST" action="http://dummy.com">
	//!       <input name="str" type="hidden" value="gurka">
	//! </form>
	//! </body></html>
}

test("Bug 173104 - POST URL:s must be unique")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	OP_STATUS status;
	FramesDocument* frames_doc = state.doc;
	URL submit_url = form_submitter.GetURL(frames_doc, status);

	verify(submit_url.GetAttribute(URL::KUnique));
}

html
{
	//! <html><body>
	//! <form name="intro" method="GET" action="http://dummy.com">
	//!       <input name="str" type="hidden" value="gurka">
	//! </form>
	//! </body></html>
}

test("Bug 173104 extension - GET URL:s should not be unique")
	language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = NULL;
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	OP_STATUS status;
	FramesDocument* frames_doc = state.doc;
	URL submit_url = form_submitter.GetURL(frames_doc, status);

	verify(!submit_url.GetAttribute(URL::KUnique));
}

html
{
	//! <html><body>
	//! <form name="intro" method="GET" action="http://dummy.com">
	//!       <input name="str" type="hidden" value="gurka">
    //!		<input type="image" src="dummy.png">
	//! </form>
	//! </body></html>
}

test("Bug 192136 - missing image coordinates #1")
    language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_IMAGE);
	int x = 11;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "str=gurka&x=11&y=23";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><body>
	//! <form name="intro" method="GET" action="http://dummy.com">
	//!       <input name="str" type="hidden" value="gurka">
    //!		<input type="image" name="test" src="dummy.png">
	//! </form>
	//! </body></html>
}

test("Bug 192136 - missing image coordinates #2")
    language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input", 2);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_IMAGE);
	int x = 11;
	int y = 23;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
	const char* expected_data = "str=gurka&test.x=11&test.y=23";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html><body>
	//! <form name="intro" method="GET" action="http://dummy.com">
    //!		<input type="image" name="test" src="dummy.png" value="hejsan">
	//! </form>
	//! </body></html>
}

test("Submitting type=image with value")
    language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input");
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_IMAGE);
	int x = 74;
	int y = 6;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
    // This is Mozilla:
    //	const char* expected_data = "test.x=74&test.y=6&test=hejsan";
    // This is MSIE and Opera:
    const char* expected_data = "test.x=74&test.y=6";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <html>
	//! <body onload="">
	//! <form action='/dummy.htm' method='get'>
	//! <input type="checkbox" name="dummy" value="1"  />
	//! <input type="submit" name="" value="ClickMe" />
	//! </form>
	//! </body>
	//! </html>
}

test("Submitting with empty submit button name - Bug 200493")
    language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input",2);
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 74;
	int y = 6;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);
    // Mozilla: "=ClickMe"
    // MSIE: ""
    // Opera8: ""
    const char* expected_data = "";
	FramesDocument* frames_doc = state.doc;
	verify(CompareGetSubmitData(form_submitter, frames_doc, expected_data));
}

html
{
	//! <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
	//! <html>
	//! <body>
	//! <p>PASS if no crash</p>
	//! 	<form>
	//! 	<fieldset>
	//! 	  </fieldset>
	//! 	<input type="reset">
	//! 	</form>
	//! </body>
	//! </html>
}

test("No crash with fieldset and reset - bug 201849")
{
    document.forms[0].reset();
}

html
{
	//! <html><body>
	//! <form action="http://localhost:8080/lek.jsp" method="POST"
	//!       enctype="MULTIPART/FORM-DATA">
	//! <input name="knapp" type="submit" value="Submit">
	//! <input name="field" type="hidden" value="value">
	//! <input name="pir" type="hidden" value="boat">
	//! </form></body></html>
}

test("case insensitive enctype - Bug 228773")
    language C++;
{
	URL parent_url;
	HTML_Element* form_elm = find_element("form");
	HTML_Element* submit_elm = find_element("input");
	verify(submit_elm);
	verify(submit_elm->GetInputType() == INPUT_SUBMIT);
	int x = 0;
	int y = 0;
	Form form_submitter(parent_url, form_elm, submit_elm, x, y);


	const char* expected_data =
		"Content-Type: multipart/form-data; boundary=----------NvhpDEAMnWcRi6tc8L7UFZ\r\n"
		"\r\n"
		"------------NvhpDEAMnWcRi6tc8L7UFZ\r\n"
		"Content-Disposition: form-data; name=\"knapp\"\r\n"
		"\r\n"
		"Submit\r\n"
		"------------NvhpDEAMnWcRi6tc8L7UFZ\r\n"
		"Content-Disposition: form-data; name=\"field\"\r\n"
		"\r\n"
		"value\r\n"
		"------------NvhpDEAMnWcRi6tc8L7UFZ\r\n"
		"Content-Disposition: form-data; name=\"pir\"\r\n"
		"\r\n"
		"boat\r\n"
		"------------NvhpDEAMnWcRi6tc8L7UFZ--\r\n";
	FramesDocument* frames_doc = state.doc;
	verify(CompareMultiPartSubmitData(form_submitter, frames_doc, expected_data));
}
